<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Procedure Suite - Clinical Dashboard</title>
    <link rel="stylesheet" href="./styles.css" />

    <!-- Monaco Editor (AMD loader) -->
    <script
      src="https://cdn.jsdelivr.net/npm/monaco-editor@0.45.0/min/vs/loader.js"
      crossorigin="anonymous"
    ></script>
    <script>
      window.__monacoReady = new Promise((resolve, reject) => {
        try {
          require.config({
            paths: {
              vs: "https://cdn.jsdelivr.net/npm/monaco-editor@0.45.0/min/vs",
            },
            onNodeCreated: function (node) {
              node.crossOrigin = "anonymous";
            },
          });
          require(["vs/editor/editor.main"], () => resolve(), reject);
        } catch (e) {
          reject(e);
        }
      });
      window.__monacoReady.catch((e) => {
        const el = document.getElementById("statusText");
        if (el) el.textContent = `Monaco failed to load: ${e?.message || e}`;
      });
    </script>
    <script type="module" src="./app.js"></script>
  </head>
  <body>
    <header class="topbar">
      <div class="title">
        <div class="h1">Procedure Suite - Clinical Dashboard</div>
        <div class="subtle">
          Client-side PHI detection. Scrub notes before submission.
        </div>
      </div>
      <div class="topbar-links">
        <a class="topbar-link" href="./reporter_builder.html">Reporter Builder</a>
        <a class="topbar-link" href="./workflow.html">Workflow</a>
      </div>
      <div class="status">
        <span id="statusText">Loading...</span>
        <span id="progressText" class="progress"></span>
      </div>
    </header>

    <main class="layout">
      <section class="editorPane">
        <!-- Section 1: De-identify Note -->
        <div class="section-header">
          <div class="section-title">
            <span class="section-number">1</span>
            De-identify Note
          </div>
        </div>

	        <div class="controls">
	          <button id="runBtn">Run Detection</button>
	          <button id="cancelBtn" class="secondary" disabled>Cancel</button>
	          <div class="spacer"></div>
	          <label class="inline-toggle" title="If enabled, clinician/provider names are treated as PHI and will be redacted.">
	            <input id="redactProvidersToggle" type="checkbox" checked />
	            Redact clinician names
	          </label>
	          <button id="applyBtn" class="primary" disabled>Apply Redactions</button>
	          <button id="revertBtn" class="secondary" disabled>Revert</button>
	          <button id="submitBtn" class="success" disabled>Submit Scrubbed Note</button>
	          <button id="newNoteBtn" class="secondary" disabled>New Note</button>

          <!-- Manual Redaction Controls -->
          <div class="manual-redaction-group">
            <label class="manual-label">Manual:</label>
            <select id="entityTypeSelect" class="param-select">
              <option value="PATIENT">Patient Name</option>
              <option value="ID">MRN / ID</option>
              <option value="DATE">Date</option>
              <option value="PHONE">Phone</option>
              <option value="GEO">Location</option>
              <option value="OTHER">Other</option>
            </select>
            <button id="addRedactionBtn" class="secondary" disabled>Add</button>
          </div>

          <div class="pdf-upload-group">
            <label class="manual-label" for="pdfUploadInput">PDF:</label>
            <input id="pdfUploadInput" type="file" accept="application/pdf,.pdf" />
            <select id="pdfOcrQualitySelect" class="param-select" title="Local OCR quality mode">
              <option value="fast" selected>OCR Fast</option>
              <option value="high_accuracy">OCR High Accuracy</option>
            </select>
            <select id="pdfOcrMaskSelect" class="param-select" title="Mask photo regions before OCR (local-only)">
              <option value="auto" selected>Mask Auto</option>
              <option value="on">Mask On</option>
              <option value="off">Mask Off</option>
            </select>
            <button id="pdfExtractBtn" class="secondary" type="button" disabled>Extract PDF Text</button>
            <button id="cameraScanBtn" class="secondary" type="button">Scan Photo</button>
          </div>
        </div>

        <div id="pdfExtractSummary" class="subtle pdf-upload-summary">
          Input options: paste note text directly, or upload a PDF for layout-aware local extraction with safety gating before PHI detection.
        </div>
        <div id="cameraScanSummary" class="subtle pdf-upload-summary camera-upload-summary hidden"></div>

        <div class="warning">
          <strong>PHI Policy:</strong> This page runs detection locally in your browser.
          Apply redactions before submitting. The server receives only scrubbed text.
        </div>

        <details id="bundlePanel" class="bundle-panel">
          <summary>Bundle (Zero-Knowledge Timeline)</summary>
          <div class="bundle-panel-body">
            <div class="bundle-grid">
              <div class="bundle-field">
                <label for="indexDateInput">Index date (T=0)</label>
                <input id="indexDateInput" type="date" />
              </div>
              <div class="bundle-field">
                <label for="docDateInput">Document date</label>
                <input id="docDateInput" type="date" />
              </div>
              <div class="bundle-field">
                <label for="timepointRoleSelect">Timepoint role</label>
                <select id="timepointRoleSelect" class="param-select">
                  <option value="PREOP_IMAGING">Pre-op imaging</option>
                  <option value="INDEX_PROCEDURE" selected>Index procedure</option>
                  <option value="PATHOLOGY">Pathology</option>
                  <option value="FOLLOW_UP">Follow-up</option>
                </select>
              </div>
              <div class="bundle-field">
                <label for="docSeqInput">Seq</label>
                <input id="docSeqInput" type="number" min="1" step="1" value="1" />
              </div>
            </div>

            <div class="bundle-actions">
              <label
                class="inline-toggle"
                title="If enabled, detected absolute dates are replaced with [DATE: T±N DAYS] tokens using Index date (UTC-noon math)."
              >
                <input id="translateDatesToggle" type="checkbox" checked />
                Translate dates to T tokens
              </label>
              <button id="chronoPreviewBtn" class="secondary" disabled>Chronology Preview</button>
            </div>

            <hr class="bundle-divider" />

            <div class="bundle-grid">
              <div class="bundle-field">
                <label for="zkPatientIdInput">ZK patient id</label>
                <input id="zkPatientIdInput" type="text" placeholder="zk_..." />
              </div>
              <div class="bundle-field">
                <label for="episodeIdInput">Episode id</label>
                <input id="episodeIdInput" type="text" placeholder="ep_..." />
              </div>
              <div class="bundle-field bundle-field-wide">
                <button id="genBundleIdsBtn" class="secondary">Generate IDs</button>
              </div>
            </div>

            <div class="bundle-actions">
              <button id="addToBundleBtn" class="secondary" disabled>Add scrubbed note to bundle</button>
              <button id="submitBundleBtn" class="primary" disabled>Submit bundle</button>
              <button id="clearBundleBtn" class="secondary" disabled>Clear bundle</button>
              <button id="clearCurrentNoteBtn" class="secondary" disabled>Clear current note</button>
            </div>

            <div id="bundleDocsHost" class="bundle-docs-host subtle">No bundle docs yet.</div>
          </div>
        </details>

        <div id="editor" class="editor">
          <textarea
            id="fallbackTextarea"
            class="fallback-textarea"
            placeholder="Paste a procedure note here…"
            spellcheck="false"
          ></textarea>
        </div>

        <!-- Section 2: Clinical Review -->
        <div class="result">
          <div class="resultHeader">
            <div class="section-title">
              <span class="section-number">2</span>
              Clinical Review
            </div>
            <div class="result-actions">
              <div class="layout-actions">
                <button id="focusClinicalBtn" class="secondary" disabled title="Expand the clinical editor (hide billing tables)">
                  Clinical
                </button>
                <button id="focusBillingBtn" class="secondary" disabled title="Expand billing tables (hide clinical editor)">
                  Billing
                </button>
                <button id="splitReviewBtn" class="secondary" disabled title="Side-by-side note + review panels">
                  Split view
                </button>
              </div>
              <button id="exportBtn" class="secondary" disabled>Export JSON</button>
              <button id="exportTablesBtn" class="secondary" disabled>Export Tables</button>
              <button id="exportEditedBtn" class="secondary" disabled>Export Edited JSON</button>
              <button id="exportPatchBtn" class="secondary" disabled>Export Patch</button>
            </div>
          </div>
		          <div id="resultsContainer" class="resultsContainer hidden">
		            <div id="statusBannerHost"></div>
                <div id="bundleSummaryHost" class="bundle-summary hidden"></div>
		            <div id="statCards" class="stat-card-container">
		            </div>

		            <div id="registryLegacyRoot">
		            <div class="dash-grid">
		              <div class="dash-col">
		                <div class="dash-card">
		                  <div class="dash-card-header">
		                    <div class="section-title">
	                      <span class="section-number">1</span>
	                      CPT Codes – Derived (Selected)
	                    </div>
	                  </div>
	                  <div class="dash-card-body">
	                    <table class="dash-table">
	                      <thead>
	                        <tr>
	                          <th width="12%">CPT Code</th>
	                          <th width="58%">Description & Rationale</th>
	                          <th width="10%">Units</th>
	                          <th width="20%">Role</th>
	                        </tr>
	                      </thead>
	                      <tbody id="billingSelectedBody"></tbody>
	                    </table>
	                  </div>
	                </div>

	                <div class="dash-card">
	                  <div class="dash-card-header">
	                    <div class="section-title">
	                      <span class="section-number">2</span>
	                      CPT Codes – Dropped / Suppressed
	                    </div>
	                  </div>
	                  <div class="dash-card-body">
	                    <table class="dash-table">
	                      <thead>
	                        <tr>
	                          <th width="12%">CPT Code</th>
	                          <th width="18%">Status</th>
	                          <th width="70%">Reason / Logic</th>
	                        </tr>
	                      </thead>
	                      <tbody id="billingSuppressedBody"></tbody>
	                    </table>
	                  </div>
	                </div>

	                <div class="dash-card">
	                  <div class="dash-card-header">
	                    <div class="section-title">
	                      <span class="section-number">3</span>
	                      Coding Logic &amp; Rationale (Per Code)
	                    </div>
	                  </div>
	                  <div class="dash-card-body">
	                    <table class="dash-table">
	                      <thead>
	                        <tr>
	                          <th width="12%">CPT Code</th>
	                          <th width="48%">Selection Logic</th>
	                          <th width="40%">Supporting Documentation Evidence</th>
	                        </tr>
	                      </thead>
	                      <tbody id="codingRationaleBody"></tbody>
	                    </table>
	                  </div>
	                </div>

	                <div class="dash-card">
	                  <div class="dash-card-header">
	                    <div class="section-title">
	                      <span class="section-number">4</span>
	                      Rules Applied (Bundling &amp; Policy)
	                    </div>
	                  </div>
	                  <div class="dash-card-body">
	                    <table class="dash-table">
	                      <thead>
	                        <tr>
	                          <th width="20%">Rule Type</th>
	                          <th width="20%">Codes Affected</th>
	                          <th width="15%">Outcome</th>
	                          <th width="45%">Details</th>
	                        </tr>
	                      </thead>
	                      <tbody id="rulesAppliedBody"></tbody>
	                    </table>
	                  </div>
	                </div>

	                <div class="dash-card">
	                  <div class="dash-card-header">
	                    <div class="section-title">
	                      <span class="section-number">5</span>
	                      Financial Summary
	                    </div>
	                  </div>
	                  <div class="dash-card-body">
	                    <div class="dash-metrics">
	                      <div class="dash-metric">
	                        <div class="dash-metric-label">Total work RVU</div>
	                        <div class="dash-metric-value" id="financialTotalRVU">—</div>
	                      </div>
	                      <div class="dash-metric">
	                        <div class="dash-metric-label">Estimated payment</div>
	                        <div class="dash-metric-value" id="financialTotalPayment">—</div>
	                      </div>
	                    </div>
	                    <table class="dash-table">
	                      <thead>
	                        <tr>
	                          <th width="12%">CPT</th>
	                          <th width="10%">Units</th>
	                          <th width="18%">Work RVU</th>
	                          <th width="20%">Facility RVU</th>
	                          <th width="20%">Payment</th>
	                          <th width="20%">Notes</th>
	                        </tr>
	                      </thead>
	                      <tbody id="financialSummaryBody"></tbody>
	                    </table>
	                  </div>
	                </div>

	                <div class="dash-card">
	                  <div class="dash-card-header">
	                    <div class="section-title">
	                      <span class="section-number">6</span>
	                      Audit &amp; Quality Flags (Condensed)
	                    </div>
	                  </div>
	                  <div class="dash-card-body">
	                    <table class="dash-table">
	                      <thead>
	                        <tr>
	                          <th width="30%">Category</th>
	                          <th width="70%">Notes</th>
	                        </tr>
	                      </thead>
	                      <tbody id="auditFlagsBody"></tbody>
	                    </table>
	                    <details class="dash-details">
	                      <summary>Pipeline metadata</summary>
	                      <table class="dash-table kv-table">
	                        <tbody id="pipelineMetadataBody"></tbody>
	                      </table>
	                    </details>
	                  </div>
	                </div>
		              </div>

		              <div class="dash-col">
		                <div class="dash-card hidden" id="completenessPromptsCard">
		                  <div class="dash-card-header">
		                    <div class="section-title">
		                      <span class="section-number">7</span>
		                      Suggested Missing Fields (Completeness)
		                    </div>
		                    <div class="dash-card-actions no-print">
		                      <button id="completenessCopyBtn" type="button" class="secondary small-btn" title="Copy checklist to clipboard">
		                        Copy checklist
		                      </button>
		                      <button id="completenessOpenReporterBtn" type="button" class="secondary small-btn" title="Open Reporter Builder with the current scrubbed note">
		                        Open Reporter Builder
		                      </button>
		                    </div>
		                  </div>
		                  <div class="dash-card-body padded">
		                    <div id="completenessPromptsBody"></div>
		                  </div>
		                </div>
		                <div id="registryGridRoot" class="hidden"></div>
		                <div id="registryLegacyRightRoot">
		                  <div id="proceduresSummaryCard" class="dash-card clinical-hero-card">
		                    <div class="dash-card-header">
		                      <div class="section-title">
		                        <span class="section-number">8</span>
		                        Procedures Performed
		                      </div>
		                    </div>
		                    <div class="dash-card-body" id="proceduresSummaryHost"></div>
		                  </div>

		                  <div id="clinicalContextCard" class="dash-card">
		                    <div class="dash-card-header">
		                      <div class="section-title">
		                        <span class="section-number">9</span>
		                        Patient &amp; Clinical Context
		                      </div>
		                    </div>
		                    <div class="dash-card-body">
		                      <div id="clinicalContextHost"></div>
		                    </div>
		                  </div>

		                  <div id="procedureDetailPanels"></div>
		                </div>
		              </div>
		            </div>

	            <details class="raw-json-toggle">
	              <summary>Evidence Traceability</summary>
	              <div id="evidenceTraceabilityHost"></div>
	            </details>

	            <div class="debug-section no-print">
		              <details class="debug-details">
		                <summary>System Logic & Debugging Logs</summary>
		                <div id="systemLogs" class="log-box">
	                </div>
	              </details>
	            </div>
		          </div>

	            <details class="raw-json-toggle">
	              <summary>View Raw JSON</summary>
	              <pre id="serverResponse">(none)</pre>
	            </details>

            <details class="raw-json-toggle">
              <summary>Flattened Tables (Editable)</summary>
              <div id="flattenedTablesHost" class="flat-tables-host"></div>
            </details>

            <details class="raw-json-toggle">
              <summary>Edited JSON (Training)</summary>
              <pre id="editedResponse">(no edits yet)</pre>
            </details>

            <details class="raw-json-toggle" id="feedbackPanel">
              <summary>Feedback &amp; Corrections</summary>
              <div class="feedback-panel">
                <div class="subtle" id="runIdDisplay">Run ID: (not persisted)</div>

                <div class="feedback-grid">
                  <div class="feedback-field">
                    <label for="submitterName">Name</label>
                    <input id="submitterName" type="text" placeholder="Your name (no auth yet)" />
                  </div>

                  <div class="feedback-field">
                    <label for="feedbackRating">Rating (1–10)</label>
                    <input id="feedbackRating" type="number" min="1" max="10" step="1" value="8" />
                  </div>
                </div>

                <div class="feedback-field">
                  <label for="feedbackComment">Comment</label>
                  <textarea
                    id="feedbackComment"
                    rows="4"
                    placeholder="What was right/wrong? What should change?"
                  ></textarea>
                </div>

                <div class="feedback-actions">
                  <button id="submitFeedbackBtn" class="secondary" disabled>Submit feedback</button>
                  <button id="saveCorrectionsBtn" class="secondary" disabled>Save corrections</button>
                  <div class="subtle" id="feedbackStatus"></div>
                </div>
              </div>
            </details>
          </div>
        </div>
      </section>

      <aside class="sidePane">
        <div class="sideHeader">
          <div class="sideTitle">Detections</div>
          <div class="sideHeaderActions">
            <div class="sideMeta">
              <span id="detectionsCount">0</span>
              <span class="subtle">items</span>
            </div>
            <button
              id="toggleDetectionsPaneBtn"
              class="secondary icon-btn"
              type="button"
              title="Collapse detections panel"
              aria-label="Collapse detections panel"
            >
              ⟨
            </button>
          </div>
        </div>
        <div id="detectionsList" class="detectionsList"></div>
        <div class="sideFooter">
          Uncheck items to exclude from redaction.
        </div>
      </aside>
    </main>

    <dialog id="phiConfirmModal" class="modal">
      <form method="dialog" class="modal-content">
        <h3>Confirm PHI removal before persistence</h3>
        <p class="subtle">
          You are about to save this note + results on the server for training/review. The server
          must store <strong>scrubbed-only</strong> text. Confirm you have removed PHI.
        </p>
        <p class="subtle">
          <a href="/ui/phi_identifiers" target="_blank" rel="noopener">View PHI identifiers list</a>
        </p>
        <div class="modal-actions">
          <button value="cancel" class="secondary">Cancel</button>
          <button value="confirm" class="primary">Confirm PHI removal</button>
        </div>
      </form>
    </dialog>

    <dialog id="chronoPreviewModal" class="modal modal-wide">
      <form method="dialog" class="modal-content">
        <h3>Chronology Preview (client-side)</h3>
        <p class="subtle">
          This preview runs locally. Absolute dates never leave your browser. Verify how detected
          dates will be tokenized before bundling.
        </p>
        <div id="chronoPreviewBody" class="chrono-preview-body"></div>
        <div class="modal-actions">
          <button value="close" class="primary">Close</button>
        </div>
      </form>
    </dialog>

    <dialog id="cameraScanModal" class="modal modal-wide">
      <form method="dialog" class="modal-content camera-modal-content">
        <h3>Camera Scan (Local OCR)</h3>
        <p class="subtle">
          Captured images and OCR run entirely in your browser. No raw camera images or unredacted text are uploaded.
        </p>

        <div class="camera-modal-body">
          <div class="camera-preview-wrap">
            <video id="cameraPreview" autoplay playsinline muted></video>
            <div id="cameraGuideOverlay" class="camera-guide-overlay">
              <div class="camera-guide-frame"></div>
              <div id="cameraGuideHint" class="camera-guide-hint">Align document inside frame. Hold steady and reduce glare.</div>
            </div>
          </div>

          <div class="camera-options-row">
            <label class="manual-label" for="cameraOcrQualitySelect">OCR:</label>
            <select id="cameraOcrQualitySelect" class="param-select" title="Camera OCR quality mode">
              <option value="fast" selected>Fast</option>
              <option value="high_accuracy">High Accuracy</option>
            </select>

            <label class="manual-label" for="cameraEnhanceSelect">Enhance:</label>
            <select id="cameraEnhanceSelect" class="param-select" title="Image preprocessing mode">
              <option value="auto" selected>Auto (Recommended)</option>
              <option value="grayscale">Grayscale</option>
              <option value="bw_high_contrast">B/W High Contrast</option>
              <option value="off">Off</option>
            </select>

            <label class="manual-label" for="cameraSceneHintSelect">Capture:</label>
            <select id="cameraSceneHintSelect" class="param-select" title="Capture source optimization">
              <option value="auto" selected>Auto (Recommended)</option>
              <option value="monitor">Computer Monitor</option>
              <option value="document">Paper Document</option>
            </select>
          </div>

          <div class="camera-actions-row">
            <button id="cameraStartBtn" type="button" class="secondary">Start Camera</button>
            <button id="cameraCaptureBtn" type="button" class="secondary" disabled>Capture Page</button>
            <button id="cameraRetakeBtn" type="button" class="secondary" disabled>Retake Last</button>
            <button id="cameraClearBtn" type="button" class="secondary" disabled>Clear All</button>
            <button id="cameraRunOcrBtn" type="button" class="primary" disabled>Run OCR</button>
          </div>

          <div class="camera-status-row">
            <span id="cameraStatusText" class="subtle">Start camera to capture pages.</span>
            <span id="cameraProgressText" class="progress"></span>
          </div>

          <div id="cameraWarningList" class="camera-warning-list"></div>
          <div id="cameraThumbStrip" class="camera-thumb-strip" aria-live="polite"></div>

          <div id="cameraCropPanel" class="camera-crop-panel hidden">
            <div class="camera-crop-header">Crop Before OCR (Client-side)</div>
            <div class="subtle">
              Optional: crop out monitor background/images before text extraction. Cropping happens locally in your browser.
            </div>

            <div class="camera-options-row">
              <label class="manual-label" for="cameraCropPageSelect">Page:</label>
              <select id="cameraCropPageSelect" class="param-select"></select>
            </div>

            <div id="cameraCropPreviewStage" class="camera-crop-preview-stage">
              <img id="cameraCropPreviewImg" alt="Crop preview" />
              <div id="cameraCropPreviewBox" class="camera-crop-preview-box">
                <span class="camera-crop-handle camera-crop-handle-nw" data-crop-handle="nw" aria-hidden="true"></span>
                <span class="camera-crop-handle camera-crop-handle-ne" data-crop-handle="ne" aria-hidden="true"></span>
                <span class="camera-crop-handle camera-crop-handle-se" data-crop-handle="se" aria-hidden="true"></span>
                <span class="camera-crop-handle camera-crop-handle-sw" data-crop-handle="sw" aria-hidden="true"></span>
              </div>
            </div>

            <div id="cameraCropZoomWrap" class="camera-crop-zoom hidden">
              <div class="camera-crop-zoom-label">Zoomed Crop Preview</div>
              <img id="cameraCropZoomImg" alt="Zoomed cropped preview" />
            </div>

            <div class="camera-crop-grid">
              <div class="camera-crop-field">
                <label for="cameraCropTopRange">Top <span id="cameraCropTopValue">0%</span></label>
                <input id="cameraCropTopRange" type="range" min="0" max="45" step="1" value="0" />
              </div>
              <div class="camera-crop-field">
                <label for="cameraCropRightRange">Right <span id="cameraCropRightValue">0%</span></label>
                <input id="cameraCropRightRange" type="range" min="0" max="45" step="1" value="0" />
              </div>
              <div class="camera-crop-field">
                <label for="cameraCropBottomRange">Bottom <span id="cameraCropBottomValue">0%</span></label>
                <input id="cameraCropBottomRange" type="range" min="0" max="45" step="1" value="0" />
              </div>
              <div class="camera-crop-field">
                <label for="cameraCropLeftRange">Left <span id="cameraCropLeftValue">0%</span></label>
                <input id="cameraCropLeftRange" type="range" min="0" max="45" step="1" value="0" />
              </div>
            </div>

            <div class="camera-actions-row">
              <button id="cameraCropApplyBtn" type="button" class="secondary">Apply To Page</button>
              <button id="cameraCropApplyAllBtn" type="button" class="secondary">Apply To All</button>
              <button id="cameraCropResetBtn" type="button" class="secondary">Reset Page</button>
              <button id="cameraCropResetAllBtn" type="button" class="secondary">Reset All</button>
            </div>
          </div>
        </div>

        <div class="modal-actions">
          <button id="cameraCloseBtn" value="close" class="secondary">Close</button>
        </div>
      </form>
    </dialog>

    <div id="privacyShield" class="privacy-shield" aria-hidden="true" tabindex="0">Private - tap to resume</div>
  </body>
</html>
